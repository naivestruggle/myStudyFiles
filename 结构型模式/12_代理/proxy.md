# 1、代理模式（Proxy）

## 1.1、基本介绍

- 代理模式：为对象**提供一个替身**，以控制对这个对象的访问。即通过代理对象访问目标对象，这样做的**好处是**：可以在目标对象实现的基础上，增强额外的功能操作，即扩展目标对象的功能。

- 被代理的对象可以是**远程对象**、**创建开销大的对象**、或**需要安全控制的对象**

- 代理模式有不同的形式，主要有三种 **静态代理**、**动态代理**（JDK代理、接口代理）和**Cglib代理**（可以在内存中动态地创建对象完成代理，而不需要实现接口，他是属于动态代理的）。

- 代理模式示意图

  ![1563419365446](images\代理模式示意图.png)

## 1.2、静态代理

### 1.2.1、基本介绍

静态代理在使用时，需要定义接口或者父类，被代理对象（即目标对象）与代理对象一起实现相同的接口或者是继承相同的父类

### 1.2.2、应用实例

- 定义一个接口 ITeacherDao

- 目标对象TeacherDao实现接口ITeacherDao

- 使用静态代理方式，就需要在代理对象TeacherDaoProxy中也实现ITeacherDao

- 调用的时候通过调用代理对象的方法来调用目标对象

- **特别提醒**：代理对象与目标对象要实现相同的接口，然后通过调用相同的方法来调用目标对象的方法。

- 类图

  ![1563419981935](images\静态代理应用实例类图.png)

- 实例代码（src.staticProxy）

### 1.2.3、静态代理的优缺点

- 优点：在不修改目标对象的功能前提下，能通过代理对象对目标功能扩展
- 缺点：因为代理对象需要与目标对象实现一样的接口，所以会有很多代理类
- 一旦接口增加方法，目标对象与代理对象都要维护。

## 1.3、动态代理（JDK）

### 1.3.1、基本介绍

- 代理对象不需要实现接口，但是目标对象要实现接口，否则不能用动态代理

- 代理对象的生成，是利用JDK的API，动态地在内存中构建代理对象

- 动态代理也叫：JDK代理、接口代理

- JDK中生成代理对象的API

  - 代理类所在包：java.lang.reflect.Proxy

  - JDK实现代理只需要使用newProxyInstance方法，但是该方法需要接受三个参数，完整的写法是：

    ```java
    static Object newProxyInstance(ClassLoader loader,Class<?>[] interfaces,InvocationHandler h)
    ```

    

### 1.3.2、动态代理应用实例

将前面的静态代理改进成**动态代理**模式（即：JDK代理模式）

- 类图

  ![1563421867856](images\jdk代理类图.png)

- 实例代码（src.dynamic.jdk）

## 1.4、动态代理（Cglib）

### 1.4.1、基本介绍

- 静态代理和 JDK 代理模式都要求目标对象是实现一个接口，但是有时候目标对象只是一个单独的对象，并没有实现任何的接口，这个时候可使用目标对象子类来实现代理这就是**Cglib代理**
- cglib代理也叫作**子类代理**，他是在内存中构建一个子类对象从而实现对目标对象功能扩展，有些书也**将cglib代理归属到动态代理**。
- cglib是一个强大的高性能的代码生成包，它可以在运行期扩展java类与实现java接口，它广泛的被许多AOP的框架使用，例如Spring AOP，实现方法拦截
- 在AOP编程中如何选择代理模式、
  - 目标对象需要实现接口，用JDK代理
  - 目标对象不需要实现接口，用cglib代理
- Cglib包的底层是通过使用字节码处理框架ASM来转换字节码并生成新的类

### 1.4.2、Cglib代理模式实现步骤

- 需要引入cglib的jar文件

  ![1563451359044](images\cglib所需jar包.png)

- 在内存中动态构建子类，注意代理的类不能为final，否则报错 java.lang.IllegalArgumentException
- 目标对象的方法如果为final / static，那么就不会被拦截，即不会执行目标对象额外的业务方法

### 1.4.3、Cglib代理模式应用实例

- 应用实例要求

  将前面的案例用Cglib代理模式实现

- 类图

  ![1563451777947](images\Cglib应用实例类图.png)

# 2、代理模式的变体

## 2.1、防火墙代理

内网通过代理穿透防火墙，实现对公网的访问。

## 2.2、缓存代理

比如：当请求图片文件等资源时，先到缓存代理取，如果取到资源则ok，如果取不到资源，再到公网或者数据库取，然后缓存。

## 2.3、远程代理

**远程对象的本地代表**，通过它可以**把远程对象当本地对象**来调用。远程代理通过网络和真正的远程对象沟通信息。

## 2.4、同步代理

主要使用在多线程编程中，完成多线程间的同步工作。