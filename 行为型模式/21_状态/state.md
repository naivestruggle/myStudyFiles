# 1、需求

APP抽奖活动问题

- 假如每参加一次这个活动要扣除用户50积分，中奖概率是10%

- 奖品数量固定，抽完就不能抽奖

- 活动有四个状态：可以抽奖、不能抽奖、发放奖品和奖品领完

- 活动的四个状态转换关系图如下：

  ![1563965439674](images\需求状态转换图.png)

# 2、状态模式

## 2.1、基本介绍

- 状态模式（State Pattern）：它主要用来解决对象在多种状态转换时，需要对外输出不同的行为问题。状态和行为是一一对应的，状态之间可以相互转换
- 当一个对象的内在状态改变时，允许改变其行为，这个对象看起来像是改变了其类

## 2.2、原理类图

![1563966982984](images\状态模式原理类图.png)

- 对类图的说明：
  - Context：为环境角色，用于维护State实例，这个实例定义当前状态
  - State：是抽象状态角色，定义一个接口封装与Context的一个特点接口相关行为
  - ConcreteState：具体的状态角色，每个子类实现一个与Context的一个状态相关行为



# 3、状态模式解决APP抽奖问题

## 3.1、类图

![1563967646484](images\App抽奖问题类图.png)

## 3.2、代码

# 4、状态模式在实际项目-借贷平台 源码剖析

- 借贷平台的订单，有审核-发布-抢单 等等 步骤，随着操作的不同，会改变订单的状态，项目中的这个模块实现就会使用到状态模式
- 传统方式：通常通过if/else判断订单的状态，从而实现不同的逻辑
  - 问题分析：这类代码难以应对变化，在添加一种状态时，我们需要手动添加if/else，在添加一种功能时，要对所有的状态进行判断。因此代码会变得越来越臃肿，并且一旦没有处理某个状态，便会发生极其严重的BUG，难以维护
- 状态模式：使用状态模式完成 借贷平台项目的审核模块

## 4.1、状态模式解决

- 流程图

  ![1563983126944](images\状态模式解决订单问题.png)

- 横纵坐标关系表

  ![1563983267001](images\状态模式解决订单问题横纵坐标关系表.png)

- 类图

  ![1563983439559](images\订单需求类图.png)

# 5、状态模式的注意事项和细节

- 代码有很强的可读性。状态模式将每个状态的行为封装到对应的一个类中
- 方便维护。将容易产生问题的if-else语句删除了，如果把每个状态的行为都放到一个类中，每次调用方法时都要判断当前是什么状态，不但会产生很多if-else语句，而且容易出错
- 符合开闭原则。容易增删状态
- 会产生很多类。每个状态都要一个对应的类，当状态过多时会产生很多的类，加大了维护难度
- 应用场景：当一个事件或者对象有很多种状态，状态之间会相互转换，对不同的状态要求有不同的行为的时候，可以考虑使用状态模式